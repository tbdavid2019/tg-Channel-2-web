---
import Layout from '../../layouts/base.astro'
import Header from '../../components/header.astro'
import Calendar from '../../components/calendar.astro'
import Item from '../../components/item.astro'
import { getChannelInfo } from '../../lib/telegram'
import { savePosts, getPostIdsByDate, getAdjacentDates } from '../../lib/db'
import dayjs from 'dayjs'
import timezone from 'dayjs/plugin/timezone'
import utc from 'dayjs/plugin/utc'
import { getEnv } from '../../lib/env'

dayjs.extend(utc)
dayjs.extend(timezone)

const { SITE_URL } = Astro.locals
const tz = getEnv(import.meta.env, Astro, 'TIMEZONE') ?? 'UTC'
const locale = getEnv(import.meta.env, Astro, 'LOCALE') ?? 'en'

// Get the date from URL parameter
const { date } = Astro.params
const targetDate = dayjs(date).format('YYYY-MM-DD')
const displayDate = dayjs(date).locale(locale).format('YYYYå¹´MæœˆDæ—¥ (ddd)')

// Get channel info to populate database and get channel metadata
const channel = await getChannelInfo(Astro)

// Save all posts to database for indexing
if (channel.posts && channel.posts.length > 0) {
  try {
    savePosts(channel.posts)
  } catch (e) {
    console.error('Failed to save posts:', e.message)
  }
}

// Get post IDs for this date from database
let datePostIds = []
try {
  datePostIds = getPostIdsByDate(targetDate)
} catch (e) {
  console.error('Failed to get posts by date:', e.message)
}

// Filter posts for this date
const posts = channel.posts?.filter(post => {
  const postDate = dayjs(post.datetime).tz(tz).format('YYYY-MM-DD')
  return postDate === targetDate
}) || []

// If we have more posts in DB than current fetch, we may need to fetch more
// For now, use what we have from the current fetch

// Get adjacent dates for pagination
let adjacentDates = { prevDate: null, nextDate: null }
try {
  adjacentDates = getAdjacentDates(targetDate, 30)
} catch (e) {
  console.error('Failed to get adjacent dates:', e.message)
}

// SEO - don't index date pages
const seo = { noindex: true }
---

<Layout channel={channel} id="main-container">
  <slot name="header">
    <Header channel={channel} />
  </slot>
  
  <Calendar />
  
  <div class="date-header">
    <h2>ğŸ“° {displayDate}</h2>
    <p class="post-count">{posts.length} ç¯‡æ–‡ç« </p>
  </div>
  
  <div class="items">
    {posts.length > 0 ? (
      posts.map((post) => <Item post={post} isItem={false} />)
    ) : (
      <div class="no-posts">
        <p>é€™ä¸€å¤©æ²’æœ‰æ–‡ç« </p>
        <a href={SITE_URL} class="back-link">â† è¿”å›é¦–é </a>
      </div>
    )}
  </div>

  <div class="pages-container">
    {adjacentDates.nextDate ? (
      <a href={`${SITE_URL}date/${adjacentDates.nextDate}`} title="å‰ä¸€å¤©" class="page">
        â† {dayjs(adjacentDates.nextDate).format('M/D')}
      </a>
    ) : (
      <span class="page-placeholder">&nbsp;</span>
    )}

    <div class="pages-info">
      <a href={SITE_URL} class="home-link">é¦–é </a>
    </div>

    {adjacentDates.prevDate ? (
      <a href={`${SITE_URL}date/${adjacentDates.prevDate}`} title="å¾Œä¸€å¤©" class="page">
        {dayjs(adjacentDates.prevDate).format('M/D')} â†’
      </a>
    ) : (
      <span class="page-placeholder">&nbsp;</span>
    )}
  </div>
</Layout>

<style>
  .date-header {
    text-align: center;
    margin-bottom: 24px;
    padding: 16px;
    background: var(--code-background-color);
    border-radius: 12px;
  }

  .date-header h2 {
    margin: 0;
    font-size: 1.3em;
    color: var(--primary-color);
  }

  .post-count {
    margin: 8px 0 0 0;
    color: var(--secondary-color);
    font-size: 0.9em;
  }

  .no-posts {
    text-align: center;
    padding: 40px;
    color: var(--secondary-color);
  }

  .back-link, .home-link {
    color: var(--accent-color);
    text-decoration: none;
  }

  .back-link:hover, .home-link:hover {
    text-decoration: underline;
  }
</style>
