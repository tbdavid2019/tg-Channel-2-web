---
import Layout from '../layouts/base.astro'
import Header from '../components/header.astro'
import Calendar from '../components/calendar.astro'
import Item from '../components/item.astro'
import dayjs from 'dayjs'
import timezone from 'dayjs/plugin/timezone'
import utc from 'dayjs/plugin/utc'
import { getEnv } from '../lib/env'

dayjs.extend(utc)
dayjs.extend(timezone)

const { SITE_URL } = Astro.locals
const { channel, before = true, after = true, isItem = false, showCalendar = true } = Astro.props
const posts = channel.posts ?? []
const tz = getEnv(import.meta.env, Astro, 'TIMEZONE') ?? 'UTC'

// Save posts to database for indexing
let savePosts
try {
  const db = await import('../lib/db')
  savePosts = db.savePosts
  if (posts.length > 0) {
    savePosts(posts)
  }
} catch (e) {
  console.error('Failed to save posts to database:', e.message)
}

// Get unique dates from posts for date-based pagination
const postDates = [...new Set(posts.map(post => 
  dayjs(post.datetime).tz(tz).format('YYYY-MM-DD')
))].sort().reverse()

// Get today and yesterday for pagination
const today = dayjs().tz(tz).format('YYYY-MM-DD')
const yesterday = dayjs().tz(tz).subtract(1, 'day').format('YYYY-MM-DD')

// For cursor-based pagination fallback
const beforeCursor = posts[posts.length - 1]?.id
const afterCursor = posts[0]?.id
---

<Layout channel={channel} id="main-container">
  <slot name="header">
    <Header channel={channel} />
  </slot>
  
  {showCalendar && <Calendar />}
  
  <slot />

  <div class="items">
    {posts.map((post) => <Item post={{ ...post, channel: channel.handle }} isItem={isItem} />)}
  </div>

  <div class="pages-container">
    {
      before && beforeCursor > 1 ? (
        <a href={`${SITE_URL}before/${beforeCursor}`} title="æ›´æ—©" class="page">
          â† æ›´æ—©
        </a>
      ) : (
        <span class="page-placeholder">&nbsp;</span>
      )
    }

    <div class="pages-info">
      {postDates.length > 0 && (
        <a href={`${SITE_URL}date/${postDates[0]}`} class="date-link" title="æŒ‰æ—¥æœŸç€è¦½">
          ğŸ“… {dayjs(String(postDates[0])).format('M/D')}
        </a>
      )}
    </div>
    {
      after && afterCursor ? (
        <a href={`${SITE_URL}after/${afterCursor}`} title="æ›´æ–°" class="page">
          æ›´æ–° â†’
        </a>
      ) : (
        <span class="page-placeholder">&nbsp;</span>
      )
    }
  </div>
</Layout>

<style>
  .date-link {
    color: var(--accent-color);
    text-decoration: none;
    font-size: 0.9em;
  }
  
  .date-link:hover {
    text-decoration: underline;
  }
</style>

